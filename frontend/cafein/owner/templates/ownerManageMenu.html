{% extends "layout.html" %}
{% load static %}
{% block content %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <main>
        <div>
            <div class="col contents-padding container">
                <div class="h1 border-bottom pb-3">메뉴 관리</div>
                <div class="contents-blank"></div>
                <div class="d-flex justify-content-end align-items-center">
                    <button class="btn btn-outline-brown rounded-5 mx-2 mb-0 px-4" id="menuUpdateDetails">메뉴 추가</button>
                    <button class="btn btn-outline-brown rounded-5 mx-2 mb-0 px-4" onclick="removeNemu()">선택 메뉴 삭제</button>
                    <input type="checkbox" class="mt-0 mx-2" id="all_select" name="all_select">
                    <p class="mb-0 mx-2 h3">전체 선택</p>
                </div>
                <div class="blank"></div>
                <div class="col mb-5 menu-card-width" id="menuDummy" style="display: none">
                    <div class="card h-100">
                        <input type="checkbox" class="mt-0" id="menu_checkbox_0" name="menu_checkbox_0">
                        <img id="menu_img_0" class="card-img-top menu_img_size" src="https://dummyimage.com/450x300/dee2e6/6c757d.jpg">
                        <div class="card-body p-4">
                            <div class="text-center">
                                <h4 class="fw-bolder" id="menu_menuName_0">카페 아메리카노</h4>
                                <h5 class="fw-bolder"><span id="menu_price_0"></span><span>원</span>
                                </h5>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="showMenuField" class="row gx-4 gx-lg-5 row-cols-2 row-cols-md-3 row-cols-xl-4 justify-content-center">
                    {% for menu in cafe_menu %}
                    <div class="col mb-5 menu-card-width" id="menu_{{ forloop.counter }}">
                        <div class="card h-100">
                            <input type="checkbox" class="mt-0" id="menu_checkbox_{{ forloop.counter }}" name="menu_checkbox">
                            <img id="menu_img_{{ forloop.counter }}" class="card-img-top menu_img_size" src="{{ menu.image.url }}">
                            <div class="card-body p-4">
                                <div class="text-center">
                                    <h4 class="fw-bolder" id="menu_menuName_{{ forloop.counter }}">{{ menu.name }}</h4>
                                    <h5 class="fw-bolder"><span id="menu_price_{{ forloop.counter }}">{{ menu.price }}</span><span>원</span>
                                    </h5>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <dialog id="newMenuDialog">
                <form method="dialog">
                    <div class="row p-5">
                        <div class="col pe-4">
                            <img id="dialog_image" class="card-img-top" src="https://dummyimage.com/450x300/dee2e6/6c757d.jpg">
                        </div>
                        <div class="col">
                            <form>
                                {{ menu_form.as_p }}
                            </form>
                            <menu>
                                <button id="confirmBtn" value="add">등록</button>
                                <button value="cancel">취소</button>
                            </menu>
                        </div>x
                    </div>
                </form>
            </dialog>
            <script>
                const menuUpdateButton = document.getElementById('menuUpdateDetails');
                const newMenuDialog = document.getElementById('newMenuDialog');
                let menu_length = document.getElementById("showMenuField").childElementCount;
                // “Update details” button opens the <dialog> modally
                menuUpdateButton.addEventListener('click', function onOpen() {
                    if (typeof newMenuDialog.showModal === "function") {
                        newMenuDialog.showModal();
                    } else {
                        alert("The <dialog> API is not supported by this browser");
                    }
                });
                newMenuDialog.addEventListener('close', function checkMenuDetail() {
                    // 닫았을 때 처리 방식
                    // newMenuDialog.returnValue << 무슨 버튼으로 입력했는지 확인 가능
                    // 닫았을때 취소랑 등록 버튼에 따라서 변경할수 있게 생성
                    if(newMenuDialog.returnValue == "add") {
                        const menuDetail = {
                            'name': document.getElementById('id_name').value,
                            'price': document.getElementById('id_price').value,
                            'image': document.getElementById('id_image').files[0],
                        };
                        // newMenuDialog.showModal();
                        // 입력 데이터에 대한 체크도 필요할것으로 판단됨 어떤식으로 입력할지는 모르니
                        sendMenuDetails(menuDetail)
                        addMenu(menuDetail);

                        dialogClear();
                    }else{
                        dialogClear();
                    }
                });

                function addMenu(menuDetails){
                    menu_length = menu_length + 1;
                    const newNode = document.getElementById("menuDummy").cloneNode(true);
                    newNode.setAttribute("style", "");
                    newNode.setAttribute("id", "menu_"+menu_length);
                    newNode.getElementsByTagName("input")[0].setAttribute("id", "menu_checkbox_"+menu_length);
                    newNode.getElementsByTagName("img")[0].setAttribute("id", "menu_img_"+menu_length);
                    newNode.getElementsByTagName("img")[0].setAttribute("src", dialog_image.src);
                    newNode.getElementsByTagName("h4")[0].setAttribute("id", "menu_menuName_"+menu_length);
                    newNode.getElementsByTagName("h4")[0].innerHTML = menuDetails.name;
                    newNode.getElementsByTagName("span")[0].setAttribute("id", "menu_price_"+menu_length);
                    newNode.getElementsByTagName("span")[0].innerHTML = menuDetails.price;
                    document.getElementById("showMenuField").appendChild(newNode);
                }
                function removeNemu(){
                    for (let i=0; i<=menu_length; i++){
                        if (document.getElementById("menu_checkbox_"+i) != null) {
                            if (document.getElementById("menu_checkbox_" + i).checked == true) {
                                document.getElementById("menu_" + i).remove();
                            }
                        }
                    }
                }

                const id_image = document.getElementById('id_image');
                const dialog_image = document.getElementById('dialog_image');
                id_image.addEventListener('change', () => {
                    const file = id_image.files[0];
                    const reader = new FileReader();
                    reader.addEventListener('load', () => {
                        dialog_image.src = reader.result;
                    });
                    reader.readAsDataURL(file);
                });

                function dialogClear(){
                    document.getElementById("dialog_image").src = "https://dummyimage.com/450x300/dee2e6/6c757d.jpg";
                    document.getElementById("id_name").value = '';
                    document.getElementById("id_image").value = '';
                    document.getElementById("id_price").value = '';
                }

                function sendMenuDetails(menuDetails){
                    const formData = new FormData();
                    formData.append('name', menuDetails.name)
                    formData.append('price', menuDetails.price)
                    formData.append('image', menuDetails.image)
                    $.ajax({
                        url: '',
                        type: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        beforeSend: function(data) {
                            data.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));
                        },
                        success: function(data) {
                            {#alert("메뉴 등록 완료");#}
                        },
                        error: function(data) {
                            {#alert("메뉴 등록에 실패 했습니다.");#}
                        }
                    });
                }
                function getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            // Does this cookie string begin with the name we want?
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
            </script>
        </div>
    </main>
{% endblock %}